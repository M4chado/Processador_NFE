<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extração de Dados de Nota Fiscal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="container">
        <header>
            <h1>Extração de Dados de Nota Fiscal</h1>
            <p>Carregue um PDF de nota fiscal e extraia os dados automaticamente usando IA</p>
        </header>

        <div class="card">
            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <label for="pdf_file" class="file-upload-label">
                    <i class="fa-solid fa-upload"></i>
                    <span>Selecione o arquivo PDF da nota fiscal</span>
                </label>
                <input type="file" name="pdf_file" id="pdf_file" accept=".pdf" required>
                <div id="file-name-display" class="file-name-display"></div>
                <button type="submit" class="btn-submit">
                    <i class="fa-solid fa-bolt"></i>
                    Extrair Dados
                </button>
            </form>
        </div>

        {% if resultado_json %}
        <div class="card result-card">
            <h2>Dados Extraídos</h2>
            <div class="tabs">
                <button class="tab-btn active" data-tab="formatado">Visualização Formatada</button>
                <button class="tab-btn" data-tab="json">JSON</button>
            </div>

            <div id="formatado" class="tab-content active">
                <h3>Visualização dos Dados</h3>
                <div class="formatted-data">
                    {% if dados_formatados %}
                        <div class="data-group">
                            <h4>Fornecedor</h4>
                            <p><strong>Razão Social:</strong> {{ dados_formatados.fornecedor.razao_social or 'N/A' }}</p>
                            <p><strong>Nome Fantasia:</strong> {{ dados_formatados.fornecedor.nome_fantasia or 'N/A' }}</p>
                            <p><strong>CNPJ:</strong> {{ dados_formatados.fornecedor.cnpj or 'N/A' }}</p>
                        </div>
                        <div class="data-group">
                            <h4>Faturado</h4>
                            <p><strong>Nome:</strong> {{ dados_formatados.faturado.nome_completo or 'N/A' }}</p>
                            <p><strong>CPF/CNPJ:</strong> {{ dados_formatados.faturado.cpf_cnpj or 'N/A' }}</p>
                        </div>
                        <div class="data-group">
                            <h4>Dados da Nota</h4>
                            <p><strong>Número da NF:</strong> {{ dados_formatados.numero_nota_fiscal or 'N/A' }}</p>
                            <p><strong>Data de Emissão:</strong> {{ dados_formatados.data_emissao or 'N/A' }}</p>
                            <p><strong>Valor Total:</strong> R$ {{ "%.2f"|format(dados_formatados.valor_total|float) if dados_formatados.valor_total is not none else 'N/A' }}</p>
                        </div>
                        
                        <div class="data-group">
                            <h4>Classificação da Despesa</h4>
                            <div class="category-container">
                                {% if dados_formatados.classificacao_despesa and dados_formatados.classificacao_despesa|length > 0 %}
                                    {% for categoria in dados_formatados.classificacao_despesa %}
                                        <span class="category-tag">{{ categoria }}</span>
                                    {% endfor %}
                                {% else %}
                                    <p>Nenhuma categoria de despesa identificada.</p>
                                {% endif %}
                            </div>
                        </div>

                        <div class="data-group">
                            <h4>Produtos / Serviços</h4>
                            {% if dados_formatados.produtos and dados_formatados.produtos|length > 0 %}
                            <table class="product-table">
                                <thead>
                                    <tr>
                                        <th>Descrição</th>
                                        <th>Qtd.</th>
                                        <th>Valor Unit.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for produto in dados_formatados.produtos %}
                                    <tr>
                                        <td>{{ produto.descricao or 'N/A' }}</td>
                                        <td>{{ produto.quantidade or 'N/A' }}</td>
                                        <td>R$ {{ "%.2f"|format(produto.valor_unitario|float) if produto.valor_unitario is not none else 'N/A' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p>Nenhum produto encontrado.</p>
                            {% endif %}
                        </div>

                        <div class="data-group">
                            <h4>Parcelas / Vencimentos</h4>
                            {% if dados_formatados.parcelas and dados_formatados.parcelas|length > 0 %}
                            <table class="product-table">
                                <thead>
                                    <tr>
                                        <th>Parcela</th>
                                        <th>Data de Vencimento</th>
                                        <th>Valor da Parcela</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for parcela in dados_formatados.parcelas %}
                                    <tr>
                                        <td>{{ parcela.numero_parcela or 'N/A' }}</td>
                                        <td>{{ parcela.data_vencimento or 'N/A' }}</td>
                                        <td>R$ {{ "%.2f"|format(parcela.valor_parcela|float) if parcela.valor_parcela is not none else 'N/A' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p>Nenhuma informação de parcela encontrada.</p>
                            {% endif %}
                        </div>

                    {% else %}
                        <p>Não foi possível formatar a visualização dos dados.</p>
                    {% endif %}
                </div>
            </div>

            <div id="json" class="tab-content">
                <div class="json-header">
                    <h3>Dados em JSON</h3>
                    <button id="copy-btn" class="copy-btn">
                        <i class="fa-solid fa-copy"></i>
                        Copiar JSON
                    </button>
                </div>
                <pre><code id="json-code">{{ resultado_json }}</code></pre>
                <p class="json-footer">Este JSON contém todos os dados extraídos da nota fiscal e pode ser usado para integração com outros sistemas.</p>
            </div>
            
        </div>
        {% endif %}

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const pdfFileInput = document.getElementById('pdf_file');
            const fileNameDisplay = document.getElementById('file-name-display');
            if(pdfFileInput) {
                pdfFileInput.addEventListener('change', () => {
                    if (pdfFileInput.files.length > 0) {
                        fileNameDisplay.textContent = `Arquivo selecionado: ${pdfFileInput.files[0].name}`;
                    } else {
                        fileNameDisplay.textContent = '';
                    }
                });
            }

            const copyBtn = document.getElementById('copy-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    const jsonCode = document.getElementById('json-code').innerText;
                    navigator.clipboard.writeText(jsonCode).then(() => {
                        copyBtn.innerHTML = '<i class="fa-solid fa-check"></i> Copiado!';
                        setTimeout(() => {
                            copyBtn.innerHTML = '<i class="fa-solid fa-copy"></i> Copiar JSON';
                        }, 2000);
                    });
                });
            }

            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const tabId = btn.getAttribute('data-tab');
                    tabContents.forEach(content => {
                        content.classList.toggle('active', content.id === tabId);
                    });
                });
            });
            
            const initialActiveTab = document.querySelector('.tabs .tab-btn.active');
            if (initialActiveTab) {
                const initialTabId = initialActiveTab.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === initialTabId);
                });
            }
        });
    </script>

</body>
</html>